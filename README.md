# intercompany-importer

## STORED PROCEDURE
```bash
DROP PROCEDURE SP_INSERT_INTERCOMPANY_CONCEPT;
 
 CREATE PROCEDURE SP_INSERT_INTERCOMPANY_CONCEPT (
     IN P_TIPO NVARCHAR(100),
     IN P_PEP NVARCHAR(100),
     IN P_KOSTL NVARCHAR(100),
     IN P_CONCEPTO NVARCHAR(100),
     IN P_RACCT NVARCHAR(100),
     IN P_MARKUP DECIMAL(5,2),
     IN P_ORD_COMPRA NVARCHAR(100),
     IN P_POSICION NVARCHAR(100),
     IN P_HABILITAR BOOLEAN,
     IN P_COD_SERV NVARCHAR(100),
     OUT O_CODIGO NVARCHAR(10),
     OUT O_MENSAJE NVARCHAR(500)
 )
 LANGUAGE SQLSCRIPT
 AS
 BEGIN
 
     DECLARE V_TYPE_CODE         NVARCHAR(36) := NULL;
     DECLARE V_PROJECTELEMENT    NVARCHAR(36) := NULL;
     DECLARE V_CONCEPT_CODE      NVARCHAR(36) := NULL;
     DECLARE V_ERRORES           NVARCHAR(500) := '';
     DECLARE ROW_COUNT           INTEGER := 0;
 
     O_CODIGO := '00';
     O_MENSAJE := 'Insert exitoso';
 
     SELECT CODE INTO V_TYPE_CODE
     FROM (SELECT CODE FROM INTERCOMPANY_RECORDTYPE WHERE NAME = :P_TIPO LIMIT 1) AS TMP;
 
     SELECT CODE INTO V_CONCEPT_CODE
     FROM (SELECT CODE FROM INTERCOMPANY_CONCEPTTYPE WHERE NAME = :P_CONCEPTO LIMIT 1) AS TMP;
 
     IF :P_PEP IS NOT NULL AND LENGTH(:P_PEP) > 0 THEN
         SELECT PROJECTELEMENTUUID INTO V_PROJECTELEMENT
         FROM (SELECT PROJECTELEMENTUUID FROM MASTER_DATA_PEPELEMENT WHERE PROJECTELEMENT = :P_PEP LIMIT 1) AS TMP;
     END IF;
 
     IF V_TYPE_CODE IS NULL THEN
         V_ERRORES := V_ERRORES || 'Tipo no encontrado (' || :P_TIPO || '). ';
     END IF;
 
     IF V_CONCEPT_CODE IS NULL THEN
         V_ERRORES := V_ERRORES || 'Concepto no encontrado (' || :P_CONCEPTO || '). ';
     END IF;
 
     IF :P_PEP IS NOT NULL AND LENGTH(:P_PEP) > 0 AND V_PROJECTELEMENT IS NULL THEN
         V_ERRORES := V_ERRORES || 'PEP no encontrado (' || :P_PEP || '). ';
     END IF;
 
     -- Si hubo errores, se cancela el insert
     IF LENGTH(V_ERRORES) > 0 THEN
         O_CODIGO := '01';
         O_MENSAJE := V_ERRORES;
         RETURN;
     END IF;
 
     -- Verificación de duplicados
     IF V_CONCEPT_CODE IS NOT NULL THEN
         SELECT COUNT(*) INTO ROW_COUNT
         FROM INTERCOMPANY_CONCEPT
         WHERE TO_TYPE_CODE = V_TYPE_CODE
           AND TO_PEPELEMENT_PROJECTELEMENTUUID = V_PROJECTELEMENT
           AND TO_CONCEPTTYPE_CODE = V_CONCEPT_CODE
           AND TO_GLACCOUNT_GLACCOUNT = P_RACCT
           AND TO_PURCHASEORDERITEM_PURCHASEORDER = P_ORD_COMPRA
           AND TO_PURCHASEORDERITEM_PURCHASEORDERITEM = P_POSICION;
 
     ELSE
         SELECT COUNT(*) INTO ROW_COUNT
         FROM INTERCOMPANY_CONCEPT
         WHERE TO_TYPE_CODE = V_TYPE_CODE
           AND TO_PEPELEMENT_PROJECTELEMENTUUID = V_PROJECTELEMENT
           AND TO_COSTCENTER_COSTCENTER = NULLIF(P_KOSTL, '')
           AND TO_GLACCOUNT_GLACCOUNT = P_RACCT
           AND TO_PURCHASEORDERITEM_PURCHASEORDER = P_ORD_COMPRA
           AND TO_PURCHASEORDERITEM_PURCHASEORDERITEM = P_POSICION;
     END IF;
 
     -- Si ya existe, cancelamos
     IF ROW_COUNT > 0 THEN
         O_CODIGO := '02';
         O_MENSAJE := 'Ya existe un registro con los mismos parámetros.';
         RETURN;
     END IF;
 
     INSERT INTO INTERCOMPANY_CONCEPT (
         ID,
         CREATEDAT,
         ENABLED,
         MARKUP,
         TO_TYPE_CODE,
         TO_GLACCOUNT_GLACCOUNT,
         TO_GLACCOUNT_COMPANYCODE,
         TO_CONCEPTTYPE_CODE,
         TO_PURCHASEORDERITEM_PURCHASEORDER,
         TO_PURCHASEORDERITEM_PURCHASEORDERITEM,
         TO_PEPELEMENT_PROJECTELEMENTUUID,
         TO_COSTCENTER_COSTCENTER
     )
     VALUES (
            NEWUID(),
            CURRENT_TIMESTAMP,
            TRUE,
            P_MARKUP,
            V_TYPE_CODE,
            P_RACCT,
            '5720',
            V_CONCEPT_CODE,
            P_ORD_COMPRA,
            P_POSICION,
            V_PROJECTELEMENT,
            NULLIF(P_KOSTL, '')
    );
 
 END;
